<html lang="zh-CN">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf8"/>
        <style>
            .flex{
                flex-flow:row wrap;
                display: flex;
                width: 100%;
                height: 100%;
            }
            
            *{
                margin: 0;
                padding: 0;
                box-sizing:border-box;
                cursor: pointer;

            }
            
            .switch {
                position: relative;
                display: inline-block;
                width: 60px;
                height: 34px;
                margin-left: 10px;
            }
            .switch input {display:none;}

            .slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                -webkit-transition: .4s;
                transition: .4s;
            }

            .slider:before {
                position: absolute;
                content: "";
                height: 26px;
                width: 26px;
                left: 4px;
                bottom: 4px;
                background-color: white;
                -webkit-transition: .4s;
                transition: .4s;
            }

            input:checked + .slider {
                background-color: #2196F3;
            }

            input:focus + .slider {
                box-shadow: 0 0 1px #2196F3;
            }

            input:checked + .slider:before {
                -webkit-transform: translateX(26px);
                -ms-transform: translateX(26px);
                transform: translateX(26px);
            }

            .slider.round {
                border-radius: 34px;
            }

            .slider.round:before {
                border-radius: 50%;
            }
            
            .nav{
                font-size: 40px;

            }
            
            .blue{
                background: #00f9;
            }
            
            button{
                padding: 10px;
                width: 300px;

            }
            
            #content{
                display: flex;
                flex-direction: column;
                align-items: center;
                padding-top: 20px;
                overflow-y: auto;
            }

            #loginshado{
                display: flex;
                flex-direction: column;
                align-items: center;

                padding-top: 100px;
                width: 100%;
                height: 100%;
                background: #000f;
                position: fixed;
                display: flex;
            }
            
            #login{
                display: flex;
                flex-direction: column;
                align-items: center;
                background: #fff;
                width: 600px;
                height: 400px;
                justify-content: center;
            }
            
            .from {
                display: flex;
                margin: 20px 0;
                width: 450px;
                align-items: center;
            }

            .from span{
               min-width: 150px;
               text-align: left;
               white-space: nowrap;
            }
            
            input,select {
                width: 200px;
                height: 30px;
                margin-left: 2%;
                padding-left: 5px;
                border-radius: 3px;
                border: 1px solid #919191;
            }
        </style>
    </head>
    <body>
        <div id="app" class="flex">
            <div style="width:100%;height: 7%;border-bottom: 1px solid #000;align-items: center;display: flex;">
                <h1 style="margin-left: 10px;">数据采集器<h1>
            </div>
            <div style="width: 15%;height: 86%;border-right: 1px solid #000; overflow-y: auto;" id="nav"></div>
            <div style="width: 85%;height: 86%;" id="content"></div>
            <div style="width: 100%;height: 7%;border-top: 1px solid #000;align-items: center;display: flex;justify-content:space-between;">
                <h1><h1>
                <h2 style="margin-left: 40px;color: red;"> </h2>
            </div>
            <div id="loginshado">
                <div id="login"></div>
            </div>
        </div>
    </body>
    <script>
        var loopTime=1000
        
        var modelChangePassword={
            divid:"login",
            btntype:"changePassword",
            nodes:[
                ["修改密码","","password"]
            ],
            btns:[
                ["修改","changePassword"]
            ]
        }
        
        var model=[
            {
                divid:"login",
                btntype:"loginInit",
                nodes:[
                    ["账号","","username"],
                    ["密码","","password"]
                ],
                btns:[
                    ["登陆","login"]
                ]
            },
            {
                label:"电压电流",
                btntype:"VACollection",
                divid:"content",
                nodes:[
                    ["总闸电压(V)","",'vol'],
                    ["总闸电流(mA)","",'cur'],
                    ["电流通道1(mA)","",'curr1'],
                    ["电流通道2(mA)","",'curr2'],
                    ["电流通道3(mA)","",'curr3'],
                    ["电流通道4(mA)","",'curr4'],
                ],
            },
            {
                label:"传感器数据",
                btntype:"otherCollection",
                divid:"content",
                nodes:[
                    ["温度1","",'temp1'],
                    ["湿度1","",'humi1'],
                    ["温度2","",'temp2'],
                    ["湿度2","",'humi2'],
                    ["角度","",'pose'],
                    ["箱门1","",'door1'],
                    ["箱门2","",'door2'],
                    ["箱门3","",'door3'],
                    ["箱门4","",'door4'],
					["水浸1","",'water1'],
					["水浸2","",'water2'],
                    ["漏电1","",'ld1'],
                    ["漏电2","",'ld2'],
                ],
            },
            {
                label:"阈值设置",
                btntype:"ThresholdData",
                divid:"content",
                nodes:[
                    ["高压(V)","<!--#A-->",'A'],
					["低压(V)","<!--#B-->",'B'],
                    ["电流(mA)","<!--#Q-->",'Q'],
                    ["角度(°)","<!--#R-->",'R'],
                    ["温度_高","<!--#S-->",'S'],
                    ["温度_低","<!--#T-->",'T'],
                    ["湿度_高","<!--#U-->",'U'],
                    ["湿度_低","<!--#V-->",'V'],
                    ["漏电(mA)","<!--#W-->",'W'],
                    ["信号灯不亮(%)","<!--#ad-->",'ad'],
					["信号灯部分亮(%)","<!--#ae-->",'ae'],
                ],
                btns:[
                    ["保存","threshold_save"]
                ]
            },
            {
                label:"开关状态",
                btntype:"switchStatus",
                divid:"content",
                nodes:[
                    ["继电器1","",'sw1',{
                        type:"switch",
                    }],
                    ["继电器2","",'sw2',{
                        type:"switch",
                    }],
					["继电器3","",'sw3',{
                        type:"switch",
                    }],
					["继电器4","",'sw4',{
                        type:"switch",
                    }],
                ],
            },
            {
                label:"北斗定位",
                btntype:"BeidouData",
                divid:"content",
                nodes:[
                    ["卫星数量","",'bd_num'],
                    ["信号强度","",'bd_signal'],
                    ["定位状态","",'bd_status'],
                    ["经度","",'bd_lon'],
                    ["纬度","",'bd_lat'],
                    ["方向","",'bd_dir'],
                ],
            },

            {
                label:"系统状态",
                btntype:"systemStatus",
                divid:"content",
                nodes:[
                    ["终端序列号","",'no1'],
                    ["软件版本号","",'no2'],
                    ["硬件版本号","",'no3'],
                ],
            },
            {
                label:"系统设置",
                btntype:"systemSetting",
                divid:"content",
                nodes:[
                    ["同步时间","<!--#a-->",'a'],
                    ["本机ID","<!--#b-->",'b'],
                    ["设备名称","<!--#c-->",'c'],
                    ["登陆密码","<!--#d-->",'d'],
                    ["网络连接状态","<!--#C-->",'C'],
                    ['传输方式','','tran',{
                        type:"select",
                        options:["有线传输","无线传输","自动切换"],
                    }],
                ],
                btns:[
                    ["保存","set_save"],
                ]
            },
            {
                label:"无线网络",
                btntype:"gprsSetting",
                divid:"content",
                nodes:[
                    ["信息强度","",'sign'],
                    ["模块状态","",'gprs'],
                    ["SIM卡ICCID","",'iccid'],
                    ["模块型号","",'model'],
                    ["模块IMEI","",'imei'],
                ]
            },
            {
                label:"有线网络",
                btntype:"networkSetting",
                divid:"content",
                nodes:[
                    ["IP","<!--#e-->",'e'],
                    ["子网掩码","<!--#f-->",'f'],
                    ["网关","<!--#g-->",'g'],
                    ["DNS","<!--#h-->","h"],
                    ["MAC","<!--#L-->","L"],
                    ["主网地址1","<!--#i-->","i"],
                    ["主网地址2","<!--#K-->","K"],
                    ["信号机地址","<!--#ac-->","ac"],
					["网络延时时间","<!--#N-->","N"],
                    ["组播IP","<!--#O-->","O"],
                    ["组播端口","<!--#P-->","P"],
                ],
                btns:[
                    ["保存","local_save"]
                ]
            },
            {
                label:"服务器设置",
                btntype:"serverset",
                divid:"content",
                nodes:[
                    ["内网1地址","<!--#D-->",'D'],
                    ["内网1端口","<!--#E-->",'E'],
                    ["外网1地址","<!--#F-->",'F'],
                    ["外网1端口","<!--#G-->",'G'],
                    ["内网1地址_备份","",'back1'],
                    ["内网1端口_备份","",'back2'],
                    ["外网1地址_备份","",'back3'],
                    ["外网1端口_备份","",'back4'],
                    ["上报间隔时间","<!--#J-->",'J'],
                ],
                btns:[
                    ["保存","remote_save"]
                ]
            },
            {
                label:"升级服务器",
                btntype:"update_addr",
                divid:"content",
                nodes:[
                    ["升级url","<!--#aa-->",'aa'],
                    ["升级端口","<!--#ab-->",'ab'],
                ],
                btns:[
                    ["保存","update_save"]
                ]
            },
            {
                label:"系统操作",
                btntype:"system",
                divid:"content",
                nodes:[],
                btns:[
                    ["系统升级-有线","updatelwip"],
					["系统升级-无线","updategprs"],
                    ["恢复出厂","reset"],
                    ["设备重启","reboot"],
					["擦除存储芯片","eacres"],
                    ["清除信号灯","single_clear"],
                ]
            }
        ]
    </script>

    <script>
        var View={
            init(model,nav){
                this.model=model
                this.nav=nav
                this.selectindex=1
                this.loadcontent(0,this.model[0])
                this.loadnav(this.selectindex)
            },
            loop(){
                    this.loadcontent(this.selectj,this.selectdata)
            },
            labelhtml(i,style,label){
                return [
                    '<p onclick="View.setNav(',i,')" class="nav ',style,'">',
                        label,
                    '<p>'
                ].join('')
            },
            setNav(v){
                document.getElementById('content').innerHTML=""
                this.loadnav(v)
            },
            loadnav(v){
                var html=""
                for(var i=0;i<this.model.length;i++){
                    if(this.model[i].label){
                        html+=this.labelhtml(i,i==v?"blue":"",this.model[i].label)
                    }
                }
                this.loadcontent(v,this.model[v])
                this.nav.innerHTML=html
            },
            inputhtml(data,j,i){
                data[1]=data[1].replace(/<.*>/g,'')
                classname="from"
                var checked=data[3]==1?"checked":"";
                var s1=['<div class="switch">',
                            '<label class="switch">',
                                '<input type="checkbox" ',checked,' onchange="View.switchChange(',j,',',i,',3)">',
                                '<div class="slider round"></div>',
                            '</label>',
                        '</div>'].join('')
                var s2=data[3]!=undefined?s1:"";
                return [
                    '<div class="',classname,'">',
                        '<span>',data[0],':</span>',
                        '<input value="',data[1],'" name="',data[2],'"/>',
                        s2,
                    '</div>'
                ].join('')
            },
            switchChange(j,i,key){
                key=key||1
                var data=View.model[j].nodes[i]
                data[key]=data[key]=='1'?'0':'1'
                console.log('switchChange')
                View.click("switch",[['',data[key],data[2]+'_switch']])
            },
            swichhtml(data,j,i){
                checked=data[1]=='1'?'checked':""
                return [
                    '<div class="from">',
                        '<span>',data[0],':</span>',
                        '<label class="switch">',
                            '<input type="checkbox" ',checked,' onchange="View.switchChange(',j,',',i,')">',
                            '<div class="slider round"></div>',
                        '</label>',
                    '</div>'
                ].join('')
            },
            selectChange(j,i){
                var data=View.model[j].nodes[i]
                data[1]=document.getElementById('select'+j+''+i).value
                console.log('selectChange',data)
                View.click("select",[data])
            },
            selecthtml(data,j,i){
                var rt=['<select id="select',j,i,'" onchange="View.selectChange(',j,',',i,')">'].join('')
                for(var i=0;i<data[3].options.length;i++){
                    console.log('selected',i,data[1],i==parseInt(data[1]))
                    selected=i==parseInt(data[1])?'selected':''
                    rt+='<option value="'+i+'" '+selected+'>'+data[3].options[i]+'</options>'
                }
                rt+='</select>'
                return [
                    '<div class="from">',
                        '<span>',data[0],':</span>',
                        rt,
                    '</div>'
                ].join('')
            },
            btnhtml(i,data){
                return [
                    '<div style="text-align:center"><button class="button" onclick="View.click(\'',data[1],'\',',i,')">',
                        data[0],
                    '</button></div>'
                ].join("")
            },
            render(s,data,j){

                var html="";
                console.log('loadcontent',s,data,j)
                for(var i=0;i<data.nodes.length;i++){
                    if(s[i]){
                        data.nodes[i][1]=s[i]+''
                    }
                    if(data.nodes[i][3]&&typeof data.nodes[i][3]=='object'){
                        if(data.nodes[i][3].type=="switch"){
                            html+=this.swichhtml(data.nodes[i],j,i)
                        }else{
                            html+=this.selecthtml(data.nodes[i],j,i)
                        }
                    }else{
                        html+=this.inputhtml(data.nodes[i],j,i)
                    }
                }
                if(data.btns!=undefined){
                    for(var i=0;i<data.btns.length;i++){
                        html+=this.btnhtml(j,data.btns[i])
                    }
                }
                document.getElementById(data.divid).innerHTML=html
            },
            loadcontent(j,data){
                this.selectj=j
                this.selectdata=data
                if(j==0){
                    this.render([],data,j)
                }else{
                    if(document.getElementById(data.divid).querySelector('button')==null){
                        this.get('/setting.cgi?btntype='+data.btntype,(s)=>this.render(s[1],data,j))
                    }

                }
            },
            get(url,back){
                xmlhttp=null;
                if (window.XMLHttpRequest)
                {
		            xmlhttp=new XMLHttpRequest();
                }
                else if (window.ActiveXObject)
		        {
		            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
		        }
		        if (xmlhttp!=null)
		        {
                    xmlhttp.onreadystatechange=()=>{
                        if (xmlhttp.readyState==4&&back){
                            var data=xmlhttp.responseText
                            try {
                                data=JSON.parse(data.replace(/<.*>/g,''))
                            } catch (error) {
                                data=[500,'解析错误'+data,data.replace(/<.*>/g,'')]
                            }
                            back(data)
                        }
                    }
                    xmlhttp.open("GET",url,true);
                    xmlhttp.send(null);
                }
		        else
		        {
		            alert("Your browser does not support XMLHTTP.");
		        }
            },
            click(name,i){
                var s='/setting.cgi?btntype='+name
                var nodes=i
                if(typeof i=='number'){
                    nodes=this.model[i].nodes
                }
                if(i!=0){
                    nodes=this.model[0].nodes.concat(nodes)
                }
                var oj={}
                nodes.forEach((element,n,a) => {
                    var input=document.getElementsByName(element[2])[0]
                    if(input){
                        oj[element[2]]=input.value
                        s=s+'&'+element[2]+'='+input.value
                    }else{
                        oj[element[2]]=element[1]
                        s=s+'&'+element[2]+'='+element[1]
                    }
                });
                console.log("get",name,oj)
                if(name=="changePassword"||name=="set_save"){
                    
                    var map={changePassword:"password",set_save:"d"}
                    let p=/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[\s\S]{8,12}$/
                    if(!p.test(oj[map[name]])){
                        return alert("请输入正确密码格式：\n密码长度:8-12\n密码由数字+大写英文字符+小写英文字符组成")
                    }
                }
                this.get(s,(d)=>this.clickback(d,name))
            },
            clickback(d,name){
                console.log(name,d)
                if(name=="login"&&d[2]=='1'){
                    this.render([],modelChangePassword,0)
                    return
                }
                document.getElementById('loginshado').style.display=d[0]==401?'':'none'
                if(d[1]){
                    alert(d[1])
                }
            }
        }
        
        View.init(model,document.getElementById('nav'))
        
        if(loopTime){
            setInterval(()=>View.loop(),loopTime)
        }
    </script>
</html>
